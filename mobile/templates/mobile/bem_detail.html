{% extends "mobile/base.html" %}
{% block content %}
<h5 class="mb-3">Bem {{ bem.tombamento }}</h5>

<div class="card">
  <div class="card-body">
    <p class="mb-1"><strong>DescriÃƒÂ§ÃƒÂ£o:</strong> {{ bem.descricao }}</p>
    {% if sala_padrao %}<p class="mb-1"><strong>Sala oficial:</strong> {{ sala_padrao.nome }}</p>{% endif %}
  </div>
</div>

<form method="post" enctype="multipart/form-data" class="mt-3">
  {% csrf_token %}
  <input type="hidden" name="redir" value="detalhe">

  <div class="mb-3 position-relative">
    <label class="form-label">Sala encontrada</label>
    <input type="hidden" name="sala_encontrada_id" id="sala_encontrada_id" value="{{ sala_ini.id|default:'' }}">
    <input type="text" class="form-control" id="sala_busca" autocomplete="off"
           value="{% if sala_ini %}{{ sala_ini.nome }}{% endif %}" placeholder="Digite para buscar...">
    <div id="sala_sugestoes" class="list-group" style="position:absolute; z-index:1000; width:100%; display:none; max-height:240px; overflow:auto;"></div>
  </div>

  <div class="mb-3">
    <label class="form-label">Estado do bem</label>
    <select name="estado_encontrado" class="form-select">
      {% for code,label in ESTADO_CHOICES %}
        <option value="{{ code }}" {% if estado_ini == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
      {% if not estado_ini %}
        <option value="" selected>Ã¢â‚¬â€ Selecionar Ã¢â‚¬â€</option>
      {% endif %}
    </select>
    {% if estado_padrao %}<small class="text-muted">PadrÃƒÂ£o do cadastro: {{ estado_padrao }}</small>{% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">Carga atual (responsÃƒÂ¡vel encontrado)</label>
    <input type="text" name="responsavel_encontrado" class="form-control" value="{{ resp_ini }}">
    {% if resp_padrao %}<small class="text-muted">PadrÃƒÂ£o do cadastro: {{ resp_padrao }}</small>{% endif %}
  </div>

  <div class="mb-3">
    <label class="form-label">ObservaÃƒÂ§ÃƒÂ£o</label>
    <input type="text" name="observacao" class="form-control" value="{{ vistoria.observacao|default:'' }}">
  </div>

  <div class="mb-3">
    <label class="form-label">Foto do bem {% if foto_obrigatoria %}<span class="text-danger">*</span>{% endif %}</label>
    <input type="file" name="foto" accept="image/*" capture="environment" class="form-control" {% if foto_obrigatoria %}required{% endif %}>
    {% if vistoria and vistoria.foto %}
      <div class="mt-2"><img src="{{ vistoria.foto.url }}" style="max-width:100%; border-radius:8px;"></div>
    {% endif %}
  </div>

    <div class="d-flex" style="gap:8px;">
    <button name="acao" value="conferido" class="btn btn-success w-100">Conferido</button>
    <button name="acao" value="nao_localizado" class="btn btn-outline-danger w-100">NÃ£o localizado</button>
    <button name="acao" value="salvar" class="btn btn-outline-secondary w-100">Salvar</button>
  </div>
</form>

<script>
const $input = document.getElementById('sala_busca');
const $hidden = document.getElementById('sala_encontrada_id');
const $list = document.getElementById('sala_sugestoes');
let aborter = null;

function clearList(){ $list.innerHTML=''; $list.style.display='none'; }
function addItem(id,label){
  const a = document.createElement('a');
  a.className='list-group-item list-group-item-action';
  a.textContent = label;
  a.href='#';
  a.onclick = (e)=>{ e.preventDefault(); $input.value=label; $hidden.value=id; clearList(); };
  $list.appendChild(a);
  $list.style.display='block';
}

$input.addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  $hidden.value = '';
  if (!q){ clearList(); return; }
  try{
    if (aborter) aborter.abort();
    aborter = new AbortController();
    const resp = await fetch('/vistoria/api/salas/?q='+encodeURIComponent(q), {signal: aborter.signal});
    const data = await resp.json();
    clearList();
    (data.results||[]).forEach(it=> addItem(it.id, it.label));
  }catch(err){}
});

document.addEventListener('click', (e)=>{ if (!e.target.closest('#sala_sugestoes') && e.target!==$input){ clearList(); }});
</script>
{% endblock %}